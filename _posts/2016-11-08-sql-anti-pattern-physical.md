---
layout: post
title:  "SQLアンチパターン データベース物理設計のアンチパターン"
date:   2016-11-08 12:00:00 +0900
categories: Development
---

本日もSQLアンチパターンを読んだので、
出てきた用語やアンチパターンを一部抜粋してまとめてみます。

## ①ラウンディングエラー(丸め誤差)

FLOATデータ型を使用するというアンチパターン
FLOAT型を効果的に使用するには、その浮動小数点数の特徴を理解しておく必要がある。

### デメリット

- 丸めが避けられない
- 浮動小数点数の誤差累積は和ではなく積を計算する場合さらに大きくなる

### アンチパターンを用いてもいい場合

- 科学技術計算を行うアプリケーション

FLOATやその類似したデータ型の代わりにSQLデータ型のNUMERICまたはDECIMALを用いて、固定精度の小数点数を表すようにする。

## ②サーティワンフレーバー(31のフレーバー)

列に格納できる値を限定された値に制限することは有用。(CHECK(salutation in ('Mr', 'Ms')))
列に無効な値が含まれていないことを保証できる。

限定する値を列定義で指定するというアンチパターン。

### デメリット

- 列定義の中身を調べる手間
- メンテナンスを怠ると同期しなくなる
- 新しい定義の追加は頻繁に行うべきではない
- 定義の1つを廃止する場合、過去データに影響
- 移植が困難

### アンチパターンを用いてもいい場合

ENUMの採用は値セットが変わらない限りはあまり問題にならない。

限定する値をデータで指定するという解決策。

## ③ファントムファイル(幻のファイル)

物理ファイルの使用を必須と思い込むアンチパターン。

### デメリット

- ファイルの削除時における問題...「孤児」となったファイルが蓄積
- トランザクション分離の問題
- ロールバックジに置ける問題
- DBのバックアップツール使用時における問題
- SQLアクセス権限使用時における問題...外部ファイルにはGRANTやREVOKEなどのSQLステートメントで割り当てるアクセス権限が適用されない。
- ファイルはSQLデータ型ではない

### アンチパターンを用いてもいい場合

画像のようなデータサイズの大きいオブジェクトをデータベース外部のファイルに格納すること。

- DBの容量を減らせる
- バックアップが短時間で終了
- 画像ファイルがDB外にあればプレビューや編集が容易

これらのメリットがプロジェクトにとって重要であり問題点も深刻ではない場合。
ただ、常に2つの設計を検討すべき。
必要に応じてBLOB型を採用する。

## ④インデックスショットガン(闇雲インデックス)

データベースのパフォーマンスを改善する最善の方法は、 ***インデックス*** を効果的に使用すること。
しかし、インデックスをいつ、どのように使うべきかをきちんと理解しているソフトウェア開発者は多くない。
開発者は推測に基づいて、効果的にインデックスを使う方法を模索するしかない。

### デメリット

- インデックスをまったく定義しないか、少ししかインデックスを定義しなくなる
- インデックスを多く定義氏すぎるか役立たないインデックスを定義する
- インデックスを活用しないクエリを実行してしまう

### 解決策

MENTORの原則に基づいて効果的なインデックス管理を行うべき

- Measure(測定)...スロークエリログ
- Explain(解析)...クエリ実行計画(Query Execution Plan: QEP)の使用
- Nominate(指名)...インデックスを使わないでテーブルにアクセスしている箇所を探す
- Test(テスト)
- Optimize(最適化)...インデックスはキャッシュメモリに格納されやすくなる。キャッシュに割り当てるメモリ量の設定。
- Rebuild(再構築)...定期的なメンテナンス