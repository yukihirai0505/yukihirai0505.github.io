---
layout: post
title:  "SQLアンチパターン クエリのアンチパターン"
date:   2016-11-05 12:00:00 +0900
categories: Development
---

本日もSQLアンチパターンを読んだので、
出てきた用語やアンチパターンを一部抜粋してまとめてみます。

## ①フィア・オブ・ジ・アンノウン(恐怖のunknown)

NULLを一般値として使う、または一般値をNULLとして扱うというアンチパターン

### デメリット

- NULLはゼロと同じではないため文字列とNULLを連結するとNULLが返る
- 検索時にunknownが返る
- プレペアドステートメントでパラメータ化したSQLでNULLを一般値のように扱うのが困難

### アンチパターンを用いてもいい場合

NULLを用いること自体がアンチパターンなのではない。
NULLを一般地として使用したり、一般値をNULLに相当するものとして扱うことがアンチパターン。

## ②アンビギュアスグループ(曖昧なグループ)

非グループ化列を参照するというアンチパターン

### デメリット

- 単一値の原則(Single-Value Rule)
- SQLがクエリの意図を組んでくれるとは限らない...別の列に対してMAX関数が使われているからどの `bug_id` を出力したいのかをSQLが適切に判断してくれるだろう

#### 子メモ

クエリ就職誌にDISTINCTキーワードを使うとクエリ結果の行を減らしてすべての行を一意にすることができる。

### アンチパターンを用いてもいい場合

MySQLとSQLite
では単一値の原則に違反する列に対する結果の信頼性を保証できない。

曖昧ではない列を使用するようにすべき。

## ③ランダムセレクション

データをランダムにソートするというアンチパターン。

### デメリット

- 非決定性をもつ式(RAND関数)によってソートを行うということは、インデックスからメリットを得られない
- インデックスを使用できない場合には、テーブルはクエリ結果を手作業でソートしなければならず(テーブルスキャン)インデックスを用いたソートよりもはるかに遅くなる

### アンチパターンを用いてもいい場合

データセットが小さい場合

## ④プアマンズ・サーチエンジン(貧者のサーチエンジン)

パターンマッチ術語を使用するというアンチパターン。

### デメリット

- インデックスのメリットを得られないためすべてのテーブルの行をスキャン
- 意図しないマッチが生じる

### アンチパターンを用いてもいい場合

シンプルな用途に対して正しく使用すれば大きな価値を得られる。
複雑なクエリのためにパターンマッチ術語を使用すると困難に直面する。

解決策としては全文検索エンジンのような適切なツールを使用する。

- MySQLのフルテキストインデックス
- Oracleでのテキストインデックス
- Microsoft SQL Serverでの全文検索
- PostgreSQLでのテキスト検索
- SQLiteでの全文検索(FTS)
- サードパーティのサーチエンジン

## ⑤スパゲッティクエリ

複雑な問題をワンステップで解決しようとするアンチパターン

### デメリット

- 意図に反した結果... ***デカルト積(Cartesian product)*** が生じる。クエリで指定する2つのテーブルが関連を制限する条件をもたないときに生まれる。2つのテーブルを結合することによって、1つのテーブルの各行がもう1つのテーブルのすべての行とペアになってしまう
- クエリの記述や修正、デバッグが難しくなる
- 実行時のコスト増

### アンチパターンを用いてもいい場合

レポートの要件が1つのSQLクエリで実現するにあまりにも複雑な場合は、
レポートを複数作成する方が良い。

## ⑥インプリシットカラム(暗黙の列)

ソフトウェア開発者はキーをたくさん打つことを好まない。
SQLクエリですべての列名を指定するようなことはワイルドカードを使用することで避けがち。

ショートカットの罠に陥るというアンチパターン。

### デメリット

- パフォーマンスとスケーラビリティに悪い営業を及ぼす可能性がある

### アンチパターンを用いてもいい場合

アドオックなSQLを素早く描きたい場合には妥当。
できる限り列名は明示的に指定すべき。