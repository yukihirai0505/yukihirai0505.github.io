---
layout: post
title:  "ストアドプロシージャでなんでもありなSQL文を書いてみる"
date:   2016-09-27 13:09:43 +0900
categories: Development
---

エンジニアをやっていると、

「こんなデータが欲しい」という要望を受けることがあったり、
「こんなデータ出せないかな」なんて考えることがあります。

また、それらに対して通常のSQLを使用すると、

- 結果的には出せるけど、実行するSQL文が複数に分かれてしまう。
- うまく理想の形で出せない。

なんてことになることもあります。

そこで登場するのが**基本的になんでもあり**なストアドプロシージャです。

## ストアドプロシージャについて

ストアドプロシージャ（STORED PROCEDURE）とは

> データベースに対する一連の処理手続きを1つのプログラム（PROCEDURE）にまとめ、 リレーショナル・データベース管理システム(RDBMS)に保存（STORED）したものです。 1つのストアドプロシージャには複数のSQLを記述することが可能です。(
[http://northqra.com/stored_1.html:title]より引用)

こちらの基本的な使用の仕方は下記記事が参考になりました。


[https://dev.mysql.com/doc/refman/5.6/ja/create-procedure.html](https://dev.mysql.com/doc/refman/5.6/ja/create-procedure.html)

[http://qiita.com/setsuna82001/items/e742338eb93e3a48ba46](http://qiita.com/setsuna82001/items/e742338eb93e3a48ba46)

 上記を参考にした上で下記のようなストアドプロシージャをつくってみました。

- ① while文を使用して指定日から1ヶ月分のデータを作成する
- ② カーソルを使用してイベントに対する参加者の数をカウントするテーブルを作成する

あくまでもサンプルであり実用的なものではないのであしからずw

なお、今回のサンプルはMySQLを使用したものです。

## ① while文を使用して指定日から1ヶ月分のデータを作成する

まずは今回、練習で使用するテーブルを作成します。

```
CREATE TABLE [DB名].`event` (
  `id` INT NOT NULL,
  `start_date` DATETIME NOT NULL,
  PRIMARY KEY (`id`));
```

次に下記のようなストアドプロシージャを書いていきます。

{% gist yukihirai0505/c8e100b41760740ca668 %}

コードの中にコメントを書いてますが、
動的にSQLを作成し、それを実行しながらwhile文を回すことでデータを指定日から1ヶ月分のデータを作成するサンプルです。

呼び出し方は

```
call プロシージャ名("2016-02-21");
```

のような感じです。

## ② カーソルを使用してイベントに対する参加者の数をカウントするテーブルを作成する

次に、上記のデータをもとに各イベントのIDをカラムにとるようなテーブルを動的に作成していきたいと思います。
ここではカーソルを使用していきます。

このカーソルというのを使用するのに、いくつか通常のプログラミングや
SQL文とは違った文を使用するのでパッと見なんやこら？と思いますが
それぞれを分解して考えればわかりやすくなります。

このカーソルはあるテーブルに入っているデータを貯めておくことで、
1レコードずつの結果をループ処理してくれます。
for文のような役割を担ってくれます。


{% gist yukihirai0505/79b2a87d40976ec20853 %}

このような感じで、①で作成したeventテーブルからidのデータをカーソルに保存して

そのidをループで回しながら

すべてのeventIdをカラムにもったテーブルを作成することができます。

最初は覚えることが少し多いので戸惑いますが
わかってしまえば非常に便利です^^
