---
layout: post
title:  "SQLアンチパターン アプリケーションのアンチパターン"
date:   2016-11-06 12:00:00 +0900
categories: Development
---

本日もSQLアンチパターンを読んだので、
出てきた用語やアンチパターンを一部抜粋してまとめてみます。

## ①リーダブルパスワード(読み取り可能パスワード)

パスワードを平文で格納するというアンチパターン。

### デメリット

- 安全ではない...攻撃者がパスワードを盗むチャンスがいくつも発生

### アンチパターンを用いてもいい場合

アプリケーションが外部のサービスにアクセスするためのクライアント側になる場合のパスワードも
できるだけ暗号化すべき。

ソルトをつけてパスワードハッシュを格納する。(不可逆)

## ②SQLインジェクション

未認証の入力をコードとして実行するというアンチパターン。
SQLインジェクションはSQLクエリ文字列に動的に挿入された文字列が、開発者の意図していない方法でクエリの構文を改変することによって生じる。

### デメリット

- 構文エラーにならずに実行された場合意図しない結果になる
- SQLが改変されたときの影響は計り知れない

### アンチパターンを用いてもいい場合

正当化する理由はない

- 入力のフィルタリング
- 動的値のパラメータ化,pリペアドステートメントの使用
- ユーザーの入力をコードから隔離
- 開発者館でのレビュー

などなどSQLインジェクション対策行うべき。

## ③シュードキー・ニートフリーク(擬似キー潔癖症)

隙間を埋めるというアンチパターン
欠けている行をみつけたとき、多くの人はそれを自然に埋めたいと考える。

- 欠番を割り当てる
- 既存業に番号を振り直す

### デメリット

- 非効率でエラーを招きやすい
- 競合状態を引き起こす
- データ不一致の元

### アンチパターンを用いてもいい場合

擬似キー値の変更を正当化する理由はない。
欠番は埋めない。

## ④シー・ノー・エビル(臭いものに蓋)

簡潔なコードを書くという合理的な理由

- より短時間でアプリケーションのコーディングを行える
- テスト、文書化、ピアレビューの対象となるコードが減る
- コードが少ないので、バグが混入する可能性も少なくなる

肝心な部分を見逃すというアンチパターン

- データベースAPIの戻り値を無視
- アプリケーションコード内に点在するSQLしか読まない

開発者は簡単ん入手できる情報を見逃してしまう。

### デメリット

- 診断せずに判断する
- スペースがないなどの単純なミスを見逃しがち

### アンチパターンを用いてもいい場合

エラーに対してまったく何もする必要がない梅にはエラーチェックを省略できる。
例えばデータベースコネクションのclose関数がステータスを返したものの、
アプリケーション自身が終了の途中ならば、接続のためのリソースもクリーンアップされると考えられる。

## ⑤ディプロマティック・イミュニティ(外交特権)

ベストプラクティスに従う

- SubversionやGitなどのツールを用いて、ソースコードのバージョン管理を行う
- ユニットテストや機能テストを自動化し、実行する
- ドキュメント、仕様書、コードコメントを書き、アプリケーションの要件や実装戦略を記録する

SQLを特別扱いするというアンチパターン。
データベースコードではこれらの慣行が免除されると考える傾向がある。

### デメリット

- 多くの不要な仕事や繰り返し作業が発生する

### アンチパターンを用いてもいい場合

包括的に品質問題に取り組むべき。

## ⑥マジックビーンズ(魔法の豆)

MVCでいうモデルがアクティブレコードそのものというアンチパターン。

CRUD操作のようなマッピングをアクティブレコードと呼ぶ。

### デメリット

- アクティブレコートはモデルをデータベーススキーマに強く依存させる...テーブルの数=モデルの数 だけでなく、モデルとのやりとりを行うためのコード実装
- CRUD機能を公開してしまう
- ドメインモデル貧血症をもたらす...CRUDメソッド以外の振る舞いをもたない ビジネスロジックのコーディングが必要になる
- マジックビーンズのユニットテスト困難

### アンチパターンを用いてもいい場合

アクティブレコード自体は便利。
ただ、プロトタイプ作成時のコーディングによって技術的負債が生じる。
負債を減らすためにコードのリファクタリングを行う時間をあらかじめスケジュールに組み込んでおくべき。

## ⑦砂の城

想定不足というアンチパターン。

問題は、どのようなこと起きるかという想定と
それぞれの事象への対策が十分に検討されていないこと。
サービスを安定稼働させるには、トラブルは当然起きるものとして想定しておく必要がある。
想定しただけでは不十分で、実際に運用時に事象が起きた時にどのような対応をするべきかといった検討も必要。

- マシンの停止
- トランザクションの失敗
- 性能問題や障害が発生したときの対処ポリシー

### デメリット

- 被害の拡大

### アンチパターンを用いてもいい場合

仕組みや体制を考えるのは時間のかかる作業。
どこまでお金や手間をかけられるかは、そのシステムが停止することでどれだけの損失があるか
もしくは事業計画に影響があるか、
どの程度の停止期間なら許容できるかといったことを考慮して検討する必要がある。